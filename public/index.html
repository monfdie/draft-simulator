<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Genshin Draft</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="lobby-screen">
        <h1>Genshin Draft</h1>
        <div class="lobby-card">
            <input id="nickname-input" placeholder="Твой Никнейм" maxlength="12">
            <div class="lobby-actions">
                <button onclick="createGame()" class="btn-create">Создать (Blue)</button>
                <div class="join-block">
                    <input id="room-input" placeholder="Код комнаты">
                    <button onclick="joinGame()" class="btn-join">Войти (Red)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" style="display:none;">
        
        <div class="top-bar">
            <div class="player-info blue-info">
                <h2 id="blue-name-display">PLAYER 1</h2>
            </div>
            <div class="timer-box">
                <span id="timer">60</span>
                <div id="status">Ожидание...</div>
            </div>
            <div class="player-info red-info">
                <h2 id="red-name-display">PLAYER 2</h2>
            </div>
        </div>

        <div class="draft-board">
            
            <div class="draft-row ban-section">
                <div class="slots-group left" id="blue-bans">
                    </div>
                <div class="row-label">BANS</div>
                <div class="slots-group right" id="red-bans">
                    </div>
            </div>

            <div class="draft-row pick-section">
                <div class="slots-group left" id="blue-picks">
                    </div>
                <div class="row-label">PICKS</div>
                <div class="slots-group right" id="red-picks">
                    </div>
            </div>
        </div>

        <div class="divider-line"></div>

        <div class="char-pool" id="char-pool-container">
            </div>
    </div>

    <script>
        const socket = io();
        let myRole = '';
        let charsData = {};

        // === Инициализация слотов при загрузке ===
        function initSlots() {
            // Создаем пустые кружки для банов (по 5 штук)
            createEmptySlots('blue-bans', 5, 'ban-slot');
            createEmptySlots('red-bans', 5, 'ban-slot');
            // Создаем пустые кружки для пиков (по 5 штук)
            createEmptySlots('blue-picks', 5, 'pick-slot');
            createEmptySlots('red-picks', 5, 'pick-slot');
        }

        function createEmptySlots(containerId, count, className) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for(let i=0; i<count; i++) {
                const div = document.createElement('div');
                div.className = `slot-circle ${className}`;
                container.appendChild(div);
            }
        }

        // === ЛОГИКА ===
        function createGame() { 
            const nick = document.getElementById('nickname-input').value;
            if(!nick) return alert("Введите ник!");
            socket.emit('create_game', nick); 
        }

        function joinGame() { 
            const nick = document.getElementById('nickname-input').value;
            const room = document.getElementById('room-input').value;
            if(!nick || !room) return alert("Введите ник и код!");
            socket.emit('join_game', {roomId: room, nickname: nick}); 
        }

        socket.on('init_game', (data) => {
            myRole = data.role;
            charsData = data.chars;
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            
            initSlots();
            renderCharPool();
            updateUI(data.state);
        });

        socket.on('update_state', updateUI);
        socket.on('game_over', (state) => {
            updateUI(state);
            document.getElementById('status').innerText = "ГГ ВП (Draft Complete)";
            document.getElementById('status').style.color = "#0f0";
        });
        socket.on('timer_tick', (t) => {
            const el = document.getElementById('timer');
            el.innerText = t;
            if(t < 10) el.style.color = 'red';
            else el.style.color = '#fff';
        });
        socket.on('error_msg', (msg) => alert(msg));

        // === РЕНДЕР ПУЛА (Сетка) ===
        function renderCharPool() {
            const container = document.getElementById('char-pool-container');
            container.innerHTML = '';
            
            // Элементы в том же порядке, что и в JS
            const elements = ['cryo', 'hydro', 'pyro', 'electro', 'anemo', 'geo', 'dendro'];
            
            elements.forEach(elem => {
                const rowDiv = document.createElement('div');
                rowDiv.className = `element-row row-${elem}`;
                
                const chars = charsData[elem] || [];
                // Разделяем на левую и правую часть (как "книжка")
                const mid = Math.ceil(chars.length / 2);
                const leftPart = chars.slice(0, mid);
                const rightPart = chars.slice(mid);

                const leftDiv = document.createElement('div');
                leftDiv.className = 'pool-side left-side';
                leftPart.forEach(c => leftDiv.appendChild(createCharIcon(c)));

                const rightDiv = document.createElement('div');
                rightDiv.className = 'pool-side right-side';
                rightPart.forEach(c => rightDiv.appendChild(createCharIcon(c)));

                rowDiv.appendChild(leftDiv);
                rowDiv.appendChild(rightDiv); // Gap делается через CSS margins
                container.appendChild(rowDiv);
            });
        }

        function createCharIcon(char) {
            const div = document.createElement('div');
            div.className = 'char-option';
            div.id = `char-${char.id}`;
            div.onclick = () => tryPick(char.id);
            
            const img = document.createElement('img');
            img.src = char.img;
            div.appendChild(img);
            
            // Оверлей для статуса (галочка или крестик)
            const overlay = document.createElement('div');
            overlay.className = 'status-overlay';
            div.appendChild(overlay);

            return div;
        }

        function tryPick(charId) {
            socket.emit('action', { roomId: currentRoom, charId: charId });
        }

        // === ОБНОВЛЕНИЕ UI ===
        function updateUI(state) {
            document.getElementById('blue-name-display').innerText = state.blueName;
            document.getElementById('red-name-display').innerText = state.redName;
            
            const statusText = state.currentAction === 'ban' ? 'BANNING' : 'PICKING';
            const activeTeam = state.currentTeam === 'blue' ? state.blueName : state.redName;
            document.getElementById('status').innerText = `${statusText}: ${activeTeam}`;

            // 1. Заполняем слоты (Баны и Пики)
            fillSlots('blue-bans', state.bans.filter(b => b.team === 'blue'));
            fillSlots('red-bans', state.bans.filter(b => b.team === 'red'));
            fillSlots('blue-picks', state.bluePicks);
            fillSlots('red-picks', state.redPicks);

            // 2. Обновляем статус в общем пуле (серый, крестик, галочка)
            document.querySelectorAll('.char-option').forEach(el => {
                el.classList.remove('disabled', 'is-banned', 'is-picked');
            });

            // Баны -> Красный крестик
            state.bans.forEach(b => {
                const el = document.getElementById(`char-${b.id}`);
                if(el) el.classList.add('disabled', 'is-banned');
            });

            // Пики -> Синяя/Оранжевая галочка (или просто галочка)
            [...state.bluePicks, ...state.redPicks].forEach(id => {
                const el = document.getElementById(`char-${id}`);
                if(el) el.classList.add('disabled', 'is-picked');
            });
        }

        function fillSlots(containerId, items) {
            const container = document.getElementById(containerId);
            const slots = container.children;
            // items - массив объектов (для банов) или ID (для пиков)
            for(let i=0; i<slots.length; i++) {
                const slot = slots[i];
                slot.innerHTML = ''; // Чистим
                
                if (items[i]) {
                    const id = items[i].id || items[i]; // Обработка структуры
                    const charObj = findCharById(id);
                    if(charObj) {
                        const img = document.createElement('img');
                        img.src = charObj.img;
                        slot.appendChild(img);
                        slot.classList.add('filled');
                    }
                } else {
                    slot.classList.remove('filled');
                }
            }
        }

        function findCharById(id) {
            for (const key in charsData) {
                const found = charsData[key].find(c => c.id === id);
                if (found) return found;
            }
            return null;
        }

        let currentRoom = ''; // Будет заполнено при init_game
    </script>
</body>
</html>
