<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genshin Draft</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="lobby-screen">
        <div class="lobby-card">
            <h1>Genshin Draft</h1>
            <div class="input-group">
                <label>NICKNAME</label>
                <input id="nickname-input" placeholder="Enter Name" maxlength="15">
            </div>
            <div class="input-group">
                <label>DRAFT MODE</label>
                <select id="draft-type-select">
                    <option value="gitcg">GITCG CUP (Standard)</option>
                    <option value="gitcg_cup_2">GITCG CUP 2 (Immunity)</option>
                    <option value="classic">Classic (2 Bans / 3 Picks)</option>
                </select>
            </div>
            <button class="btn-primary" onclick="createGame()">Create Game (Blue)</button>
            <div class="separator"><span>OR</span></div>
            <div class="input-group">
                <label>ROOM CODE (TO JOIN)</label>
                <input id="room-input" placeholder="Enter Code">
            </div>
            <div class="input-group" style="flex-direction: row; align-items: center; gap: 10px; margin-bottom: 5px;">
                <input type="checkbox" id="spectator-check" style="width: auto; margin: 0;">
                <label for="spectator-check" style="margin: 0; cursor: pointer;">Join as Spectator</label>
            </div>
            <button class="btn-secondary" onclick="joinGame()">Join Game</button>
        </div>
    </div>

    <div id="game-screen" style="display:none;">
       <div class="header">
            <div id="room-container">
                <div id="room-display" onclick="copyRoomCode()" title="Copy">CODE: ----</div>
                <span id="copy-toast">Copied!</span>
            </div>
            <div class="reserve-timer blue-res"><span id="blue-res">5:00</span></div>
            <div id="status">Waiting...</div>
            <div class="reserve-timer red-res"><span id="red-res">5:00</span></div>
        </div>

        <div class="draft-area">
            <div id="immunity-top-display" class="immunity-top-container" style="display: none;">
                <div class="im-label">IMMUNE BAN / PICK</div>
                <div class="im-row" id="immunity-icons-row"></div>
            </div>

            <div class="team-side blue-side">
                <div class="player-header">
                    <div id="blue-timer" class="turn-timer">60</div>
                    <h2 id="blue-name-display">PLAYER 1</h2>
                    <div id="blue-ready-switch" class="ready-switch" onclick="toggleReady('blue')">
                        <div class="switch-circle"></div>
                    </div>
                </div>
                <div class="ban-row" id="blue-bans"></div>
                <div class="pick-row" id="blue-picks-1"></div>
                <div class="pick-row-small" id="blue-picks-2"></div>
            </div>

            <div class="center-axis">
                <div class="mid-label ban-label">BANS</div>
                <div class="mid-label pick-label">PICKS</div>
            </div>

            <div class="team-side red-side">
                <div class="player-header">
                    <div id="red-ready-switch" class="ready-switch" onclick="toggleReady('red')">
                        <div class="switch-circle"></div>
                    </div>
                    <h2 id="red-name-display">PLAYER 2</h2>
                    <div id="red-timer" class="turn-timer">60</div>
                </div>
                <div class="ban-row" id="red-bans"></div>
                <div class="pick-row" id="red-picks-1"></div>
                <div class="pick-row-small" id="red-picks-2"></div>
            </div>
        </div>

        <div class="controls-area">
            <button id="confirm-btn" class="confirm-btn" onclick="confirmSelection()" disabled>SELECT</button>
        </div>

        <div class="char-pool" id="char-pool-container"></div>
    </div>

    <script>
        const socket = io({ transports: ['websocket'] });

        // DRAFT SCHEMAS
        const DRAFT_SCHEMAS = {
            'gitcg': [
                { team: 'blue', type: 'ban' }, { team: 'blue', type: 'ban' },
                { team: 'red', type: 'ban' },  { team: 'red', type: 'ban' },
                { team: 'blue', type: 'ban' }, 
                { team: 'blue', type: 'pick' },
                { team: 'red', type: 'pick' }, { team: 'red', type: 'pick' },
                { team: 'blue', type: 'pick' }, { team: 'blue', type: 'pick' },
                { team: 'red', type: 'ban' }, 
                { team: 'red', type: 'pick' },
                { team: 'blue', type: 'ban' }, 
                { team: 'blue', type: 'pick' },
                { team: 'red', type: 'pick' }, { team: 'red', type: 'pick' },
                { team: 'blue', type: 'pick' }, { team: 'blue', type: 'pick' },
                { team: 'red', type: 'ban' }, 
                { team: 'red', type: 'pick' },
                { team: 'blue', type: 'ban' }, 
                { team: 'blue', type: 'pick' },
                { team: 'red', type: 'ban' }, 
                { team: 'red', type: 'pick' },
                { team: 'blue', type: 'pick' }, { team: 'blue', type: 'pick' },
                { team: 'red', type: 'pick' }, { team: 'red', type: 'pick' }
            ],
            'classic': [
                { team: 'blue', type: 'ban' }, { team: 'red', type: 'ban' },       
                { team: 'red', type: 'pick' }, { team: 'blue', type: 'ban' },      
                { team: 'blue', type: 'pick' }, { team: 'red', type: 'ban' },       
                { team: 'red', type: 'pick' }, { team: 'blue', type: 'pick' },     
                { team: 'blue', type: 'pick' }, { team: 'red', type: 'pick' }       
            ]
        };
        const gitcg2 = JSON.parse(JSON.stringify(DRAFT_SCHEMAS['gitcg']));
        gitcg2[13].immunity = true; gitcg2[14].immunity = true;
        gitcg2[25].immunity = true; gitcg2[27].immunity = true;
        DRAFT_SCHEMAS['gitcg_cup_2'] = gitcg2;

        let myRole = '', currentRoom = '', currentDraftType = 'gitcg';
        let charsData = {}, selectedCharId = null, isGameStarted = false, activeTeam = 'blue'; 
        let myUserId = sessionStorage.getItem('draft_user_id') || Math.random().toString(36).substring(2);
        sessionStorage.setItem('draft_user_id', myUserId);

        const STEPS_GITCG = {
            blueBan: [1, 2, 5, 13, 21], redBan: [3, 4, 11, 19, 23],
            bluePick: [6, 9, 10, 14, 17, 18, 22, 25, 26], redPick: [7, 8, 12, 15, 16, 20, 24, 27, 28]
        };
        const STEPS_CLASSIC = { blueBan: [1, 4], redBan: [2, 6], bluePick: [5, 8, 9], redPick: [3, 7, 10] };

        function createGame() { 
            const nick = document.getElementById('nickname-input').value;
            const type = document.getElementById('draft-type-select').value;
            if(!nick) return alert("Enter nickname!");
            socket.emit('create_game', { nickname: nick, draftType: type, userId: myUserId }); 
        }
        function joinGame() { 
            const nick = document.getElementById('nickname-input').value;
            const room = document.getElementById('room-input').value;
            const isSpec = document.getElementById('spectator-check').checked;
            if(!nick || !room) return alert("Enter nickname and code!");
            socket.emit('join_game', {roomId: room, nickname: nick, asSpectator: isSpec, userId: myUserId}); 
        }

        socket.on('init_game', (data) => {
            myRole = data.role; currentRoom = data.roomId; charsData = data.chars;
            currentDraftType = data.state.draftType || 'gitcg';
            document.getElementById('room-display').innerText = `CODE: ${currentRoom}` + (myRole === 'spectator' ? " (SPEC)" : "");
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            renderRows(); updateUI(data.state);
        });

        socket.on('update_state', updateUI);
        socket.on('game_started', () => { isGameStarted = true; });
        socket.on('game_over', (state) => { updateUI(state); setTimeout(() => alert("Draft Completed!"), 500); });
        socket.on('timer_tick', (data) => {
            const t = typeof data === 'object' ? data.main : data;
            const b = document.getElementById('blue-timer'), r = document.getElementById('red-timer');
            if(activeTeam==='blue') { b.innerText=t; r.innerText="60"; b.style.color=t<10?'#ff5555':'#4facfe'; }
            else { r.innerText=t; b.innerText="60"; r.style.color=t<10?'#ff5555':'#ff6b6b'; }
            if(typeof data === 'object') {
                document.getElementById('blue-res').innerText = formatTime(data.blueReserve);
                document.getElementById('red-res').innerText = formatTime(data.redReserve);
            }
        });

        function formatTime(s) { const m=Math.floor(s/60), sec=s%60; return `${m}:${sec<10?'0':''}${sec}`; }
        function toggleReady(r) { if(myRole===r) socket.emit('player_ready', currentRoom); }
        function copyRoomCode() { navigator.clipboard.writeText(currentRoom); }
        
        function renderRows() {
            const container = document.getElementById('char-pool-container');
            container.innerHTML = '';
            
            // Ladder
            const ladder = document.createElement('div'); ladder.className = 'ladder-container';
            const schema = DRAFT_SCHEMAS[currentDraftType];
            schema.forEach((step, i) => {
                const d = document.createElement('div');
                d.className = `ladder-step step-${step.team}`;
                if(step.immunity) d.classList.add('step-immunity');
                d.id = `step-node-${i}`; d.innerText = `${i+1}. ${step.type}`;
                ladder.appendChild(d);
            });
            container.appendChild(ladder);

            // Chars
            ['cryo','hydro','pyro','electro','anemo','geo','dendro'].forEach(elem => {
                const row = document.createElement('div'); row.className = `element-row row-${elem}`;
                const chars = charsData[elem], mid = Math.ceil(chars.length/2);
                const l = document.createElement('div'); l.className = 'row-half left-half';
                chars.slice(0,mid).forEach(c => l.appendChild(createChar(c)));
                const gap = document.createElement('div'); gap.className = 'row-gap';
                const r = document.createElement('div'); r.className = 'row-half right-half';
                chars.slice(mid).forEach(c => r.appendChild(createChar(c)));
                row.appendChild(l); row.appendChild(gap); row.appendChild(r);
                container.appendChild(row);
            });
        }

        function createChar(char) {
            const el = document.createElement('div'); el.className = 'char-option'; el.id = `char-${char.id}`;
            el.innerHTML = `<img src="${char.img}">`;
            el.onclick = () => {
                if(!isGameStarted || myRole === 'spectator') return;
                document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
                selectedCharId = char.id; el.classList.add('selected-pending');
                document.getElementById('confirm-btn').disabled = false;
            };
            return el;
        }

        function confirmSelection() {
            if(selectedCharId && currentRoom) {
                socket.emit('action', { roomId: currentRoom, charId: selectedCharId });
                selectedCharId = null; document.getElementById('confirm-btn').disabled = true;
                document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
            }
        }

        function updateUI(state) {
            isGameStarted = state.gameStarted; activeTeam = state.currentTeam;
            document.getElementById('blue-ready-switch').style.display = state.gameStarted?'none':'flex';
            document.getElementById('red-ready-switch').style.display = state.gameStarted?'none':'flex';
            if(!state.gameStarted) {
                state.ready.blue ? document.getElementById('blue-ready-switch').classList.add('ready-on') : document.getElementById('blue-ready-switch').classList.remove('ready-on');
                state.ready.red ? document.getElementById('red-ready-switch').classList.add('ready-on') : document.getElementById('red-ready-switch').classList.remove('ready-on');
            }
            document.getElementById('blue-name-display').innerText = state.blueName;
            document.getElementById('red-name-display').innerText = state.redName;
            
            // Status
            let txt = "WAITING...";
            if(state.immunityPhaseActive) txt = `IMMUNITY: ${state.currentTeam} ${state.currentAction}`;
            else if(state.gameStarted) txt = `${state.currentTeam} IS ${state.currentAction==='ban'?'BANNING':'PICKING'}`;
            document.getElementById('status').innerText = txt.toUpperCase();

            // === TOP IMMUNITY DISPLAY ===
            const topDisp = document.getElementById('immunity-top-display');
            if(state.draftType === 'gitcg_cup_2') {
                topDisp.style.display = 'flex';
                const row = document.getElementById('immunity-icons-row');
                row.innerHTML = '';
                
                (state.immunityBans || []).forEach(id => addImmunityIcon(id, 'ban', row));
                (state.immunityPool || []).forEach(id => addImmunityIcon(id, 'pick', row));
            } else {
                topDisp.style.display = 'none';
            }

            // Ladder
            const idx = state.stepIndex - 1;
            const len = DRAFT_SCHEMAS[currentDraftType].length;
            if(!state.immunityPhaseActive) {
                for(let i=0; i<len; i++) {
                    const n = document.getElementById(`step-node-${i}`);
                    if(!n) continue;
                    n.classList.remove('step-active','step-done');
                    if(i < idx) n.classList.add('step-done');
                    else if(i === idx && state.gameStarted) {
                        n.classList.add('step-active');
                        setTimeout(() => n.scrollIntoView({behavior:'smooth', block:'center'}), 50);
                    }
                }
            }

            renderSlots(state);

            // Disable Logic
            document.querySelectorAll('.char-option').forEach(el => {
                el.classList.remove('disabled', 'immunity-highlight');
            });

            // 1. Global Bans -> Always disabled
            state.bans.forEach(b => document.getElementById(`char-${b.id}`)?.classList.add('disabled'));
            
            // 2. Already Picked
            [...state.bluePicks, ...state.redPicks].forEach(id => document.getElementById(`char-${id}`)?.classList.add('disabled'));

            if(state.immunityPhaseActive) {
                // Immunity Phase: cannot pick already banned-for-immunity or already picked-for-immunity
                [...state.immunityBans, ...state.immunityPool].forEach(id => 
                    document.getElementById(`char-${id}`)?.classList.add('disabled'));
            } else {
                // Main Draft
                const step = DRAFT_SCHEMAS[currentDraftType][idx];
                const isImmunityTurn = step && step.immunity;

                // === ИСПРАВЛЕНИЕ ВИЗУАЛА: БЛОКИРОВКА ПУЛА ИММУНИТЕТА ===
                state.immunityPool.forEach(id => {
                    const el = document.getElementById(`char-${id}`);
                    if(!el) return;

                    if(state.currentAction === 'ban') {
                        // Нельзя банить иммунитетных
                        el.classList.add('disabled');
                    } else if (state.currentAction === 'pick') {
                        // Пик фаза
                        if(isImmunityTurn) {
                            // Если ход иммунитетный - можно брать (если еще не взял сам)
                            const myPicks = activeTeam === 'blue' ? state.bluePicks : state.redPicks;
                            if(!myPicks.includes(id)) {
                                el.classList.remove('disabled');
                                el.classList.add('immunity-highlight');
                            }
                        } else {
                            // Если обычный пик - иммунитетные недоступны
                            el.classList.add('disabled');
                        }
                    }
                });
            }

            if(state.gameStarted && myRole !== 'spectator' && myRole !== state.currentTeam) {
                document.querySelectorAll('.char-option').forEach(el => el.classList.add('disabled'));
            }
        }

        function addImmunityIcon(id, type, container) {
            let all = []; Object.values(charsData).forEach(a => all.push(...a));
            const char = all.find(c => c.id === id);
            if(char) {
                const div = document.createElement('div');
                div.className = `im-icon im-${type}`;
                div.innerHTML = `<img src="${char.img}">`;
                container.appendChild(div);
            }
        }

        function renderSlots(state) {
            let allFlat = [];
            Object.values(charsData).forEach(arr => allFlat.push(...arr));
            const isClassic = state.draftType === 'classic';
            const steps = isClassic ? STEPS_CLASSIC : STEPS_GITCG;
            const banCount = isClassic ? 2 : 5;

            const fill = (containerId, items, max, stepNumbers, isBan) => {
                const div = document.getElementById(containerId);
                div.innerHTML = '';
                if (max === 0) return;
                for (let i = 0; i < max; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot-circle';
                    if (isBan) slot.classList.add('slot-ban');
                    let charId = null;
                    if (items[i]) charId = typeof items[i] === 'object' ? items[i].id : items[i];
                    if (charId) {
                        const char = allFlat.find(c => c.id === charId);
                        if (char) slot.innerHTML = `<img src="${char.img}">`;
                    } else {
                        const stepNum = stepNumbers[i] || '';
                        slot.innerHTML = `<span class="step-number">${stepNum}</span>`;
                    }
                    div.appendChild(slot);
                }
            };

            fill('blue-bans', state.bans.filter(b => b.team === 'blue'), banCount, steps.blueBan, true);
            fill('red-bans', state.bans.filter(b => b.team === 'red'), banCount, steps.redBan, true);

            if (isClassic) {
                fill('blue-picks-1', state.bluePicks, 3, steps.bluePick, false);
                fill('blue-picks-2', [], 0, [], false);
                fill('red-picks-1', state.redPicks, 3, steps.redPick, false);
                fill('red-picks-2', [], 0, [], false);
            } else {
                fill('blue-picks-1', state.bluePicks.slice(0, 5), 5, steps.bluePick.slice(0, 5), false);
                fill('blue-picks-2', state.bluePicks.slice(5, 9), 4, steps.bluePick.slice(5, 9), false);
                fill('red-picks-1', state.redPicks.slice(0, 5), 5, steps.redPick.slice(0, 5), false);
                fill('red-picks-2', state.redPicks.slice(5, 9), 4, steps.redPick.slice(5, 9), false);
            }
        }
    </script>
</body>
</html>
