<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genshin Draft</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="lobby-screen">
        <div class="lobby-card">
            <h1>Genshin Draft</h1>
            
            <div class="input-group">
                <label>NICKNAME</label>
                <input id="nickname-input" placeholder="Enter Name" maxlength="15">
            </div>
            
            <div class="input-group">
                <label>DRAFT MODE</label>
                <select id="draft-type-select">
                    <option value="gitcg">GITCG CUP (Standard)</option>
                    <option value="classic">Classic (2 Bans / 3 Picks)</option>
                </select>
            </div>

            <button class="btn-primary" onclick="createGame()">Create Game (Blue)</button>
            
            <div class="separator">
                <span>OR</span>
            </div>

            <div class="input-group">
                <label>ROOM CODE (TO JOIN)</label>
                <input id="room-input" placeholder="Enter Code">
            </div>
            <button class="btn-secondary" onclick="joinGame()">Join Game (Red)</button>
        </div>
    </div>

    <div id="game-screen" style="display:none;">
        <div class="header">
            <div id="room-display" onclick="copyToClipboard()" title="Click to copy code">
                CODE: ----
            </div>
            
            <div class="reserve-timer blue-res">Reserve: <span id="blue-res">5:00</span></div>
            <div id="timer">60</div>
            <div class="reserve-timer red-res">Reserve: <span id="red-res">5:00</span></div>
            <div id="status">Waiting...</div>
        </div>

        <div class="draft-area">
            <div class="team-side blue-side">
                <div class="player-header">
                    <h2 id="blue-name-display">PLAYER 1</h2>
                    <div id="blue-ready-switch" class="ready-switch" onclick="toggleReady('blue')">
                        <div class="switch-circle"></div>
                    </div>
                </div>
                <div class="ban-row" id="blue-bans"></div>
                <div class="pick-row" id="blue-picks-1"></div>
                <div class="pick-row-small" id="blue-picks-2"></div>
            </div>

            <div class="team-side red-side">
                <div class="player-header">
                    <h2 id="red-name-display">PLAYER 2</h2>
                    <div id="red-ready-switch" class="ready-switch" onclick="toggleReady('red')">
                        <div class="switch-circle"></div>
                    </div>
                </div>
                <div class="ban-row" id="red-bans"></div>
                <div class="pick-row" id="red-picks-1"></div>
                <div class="pick-row-small" id="red-picks-2"></div>
            </div>
        </div>

        <div class="controls-area">
            <button id="confirm-btn" class="confirm-btn" onclick="confirmSelection()" disabled>Select</button>
        </div>

        <div class="char-pool" id="char-pool-container"></div>
    </div>

    <script>
        const socket = io();
        let myRole = '';
        let currentRoom = '';
        let charsData = {};
        let selectedCharId = null; 
        let isGameStarted = false;
        let lastState = null;

        const STEPS_GITCG = {
            blueBan: [1, 2, 5, 13, 21],
            redBan: [3, 4, 11, 19, 23],
            bluePick: [6, 9, 10, 14, 17, 18, 22, 25, 26],
            redPick: [7, 8, 12, 15, 16, 20, 24, 27, 28]
        };

        const STEPS_CLASSIC = {
            blueBan: [1, 4],
            redBan: [2, 6],
            bluePick: [5, 8, 9],
            redPick: [3, 7, 10]
        };

        function createGame() { 
            const nick = document.getElementById('nickname-input').value;
            const type = document.getElementById('draft-type-select').value;
            if(!nick) return alert("Please enter a nickname!");
            socket.emit('create_game', { nickname: nick, draftType: type }); 
        }

        function joinGame() { 
            const nick = document.getElementById('nickname-input').value;
            const room = document.getElementById('room-input').value;
            if(!nick || !room) return alert("Please enter a nickname and room code!");
            socket.emit('join_game', {roomId: room, nickname: nick}); 
        }

        socket.on('init_game', (data) => {
            myRole = data.role;
            currentRoom = data.roomId;
            charsData = data.chars;
            
            // ВСТАВЛЯЕМ КОД + ИКОНКУ (SVG)
            document.getElementById('room-display').innerHTML = `
                CODE: <span style="color: white; font-weight: bold; margin-left: 5px;">${currentRoom}</span>
                <svg class="copy-icon" viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            `;
            
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            renderRows();
            updateUI(data.state);
        });

        // ФУНКЦИЯ КОПИРОВАНИЯ
        function copyToClipboard() {
            if(!currentRoom) return;
            navigator.clipboard.writeText(currentRoom).then(() => {
                const el = document.getElementById('room-display');
                // Визуальный эффект
                el.classList.add('copied-success');
                setTimeout(() => el.classList.remove('copied-success'), 800);
            });
        }

        socket.on('update_state', (state) => {
            lastState = state;
            updateUI(state);
        });
        
        socket.on('game_started', () => {
            isGameStarted = true;
            document.getElementById('blue-ready-switch').style.display = 'none';
            document.getElementById('red-ready-switch').style.display = 'none';
            document.getElementById('status').innerText = "DRAFT STARTED!";
            if (lastState) updateUI(lastState);
        });

        socket.on('game_over', (state) => {
            updateUI(state);
            setTimeout(() => alert("Draft Completed!"), 500);
        });

        function formatTime(s) {
            if (s < 0) s = 0;
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        socket.on('timer_tick', (data) => {
            const mainTime = typeof data === 'object' ? data.main : data;
            document.getElementById('timer').innerText = mainTime;
            
            if (typeof data === 'object') {
                document.getElementById('blue-res').innerText = formatTime(data.blueReserve);
                document.getElementById('red-res').innerText = formatTime(data.redReserve);
                
                const timerEl = document.getElementById('timer');
                if (mainTime === 0) {
                     timerEl.style.color = '#777';
                     timerEl.style.fontSize = '20px';
                } else {
                     timerEl.style.color = '#ff5555';
                     timerEl.style.fontSize = '28px';
                }
            }
        });

        function toggleReady(role) {
            if (myRole !== role) return;
            if (isGameStarted) return;
            socket.emit('player_ready', currentRoom);
        }

        function renderRows() {
            const container = document.getElementById('char-pool-container');
            container.innerHTML = '';
            const elements = ['cryo', 'hydro', 'pyro', 'electro', 'anemo', 'geo', 'dendro'];
            
            elements.forEach(elem => {
                const rowDiv = document.createElement('div');
                rowDiv.className = `element-row row-${elem}`;
                const chars = charsData[elem];
                const mid = Math.ceil(chars.length / 2);
                const leftPart = chars.slice(0, mid);
                const rightPart = chars.slice(mid);

                const leftDiv = document.createElement('div');
                leftDiv.className = 'row-half left-half';
                leftPart.forEach(char => leftDiv.appendChild(createChar(char)));

                const gapDiv = document.createElement('div');
                gapDiv.className = 'row-gap';

                const rightDiv = document.createElement('div');
                rightDiv.className = 'row-half right-half';
                rightPart.forEach(char => rightDiv.appendChild(createChar(char)));

                rowDiv.appendChild(leftDiv);
                rowDiv.appendChild(gapDiv);
                rowDiv.appendChild(rightDiv);
                container.appendChild(rowDiv);
            });
        }

        function createChar(char) {
            const el = document.createElement('div');
            el.className = 'char-option';
            el.id = `char-${char.id}`;
            el.innerHTML = `<img src="${char.img}">`;
            
            el.onclick = () => {
                if (!isGameStarted) return;
                if (lastState && myRole !== lastState.currentTeam) return;

                document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
                
                selectedCharId = char.id;
                el.classList.add('selected-pending');
                
                document.getElementById('confirm-btn').disabled = false;
            };
            return el;
        }

        function confirmSelection() {
            if (selectedCharId && currentRoom) {
                if (lastState && myRole !== lastState.currentTeam) return;

                socket.emit('action', { roomId: currentRoom, charId: selectedCharId });
                selectedCharId = null;
                document.getElementById('confirm-btn').disabled = true;
                document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
            }
        }

        function updateUI(state) {
            isGameStarted = state.gameStarted;
            lastState = state;
            
            document.getElementById('blue-name-display').innerText = state.blueName;
            document.getElementById('red-name-display').innerText = state.redName;

            const switchBlue = document.getElementById('blue-ready-switch');
            const switchRed = document.getElementById('red-ready-switch');
            
            if (state.gameStarted) {
                switchBlue.style.display = 'none';
                switchRed.style.display = 'none';
            } else {
                switchBlue.style.display = 'flex';
                switchRed.style.display = 'flex';
                if (state.ready.blue) switchBlue.classList.add('ready-on');
                else switchBlue.classList.remove('ready-on');
                if (state.ready.red) switchRed.classList.add('ready-on');
                else switchRed.classList.remove('ready-on');
            }

            const team = state.currentTeam === 'blue' ? 'BLUE' : 'RED';
            const act = state.currentAction === 'ban' ? 'BANNING' : 'PICKING';
            const isGameOver = (state.stepIndex > (state.draftType === 'classic' ? 10 : 28));
            
            let statusText = "";
            if (!state.gameStarted) {
                statusText = "WAITING FOR PLAYERS...";
            } else if (isGameOver) {
                statusText = "DRAFT COMPLETED";
            } else {
                statusText = `${team} IS ${act}`; 
            }
            document.getElementById('status').innerText = statusText;

            const poolContainer = document.getElementById('char-pool-container');
            const confirmBtn = document.getElementById('confirm-btn');
            
            if (state.gameStarted && !isGameOver && myRole === state.currentTeam) {
                poolContainer.classList.remove('pool-locked');
                confirmBtn.style.display = 'block'; 
            } else {
                poolContainer.classList.add('pool-locked');
                confirmBtn.style.display = 'none'; 
                
                if (selectedCharId) {
                    selectedCharId = null;
                    document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
                    confirmBtn.disabled = true;
                }
            }

            renderSlots(state);

            document.querySelectorAll('.char-option').forEach(el => el.classList.remove('disabled'));
            state.bans.forEach(b => document.getElementById(`char-${b.id}`)?.classList.add('disabled'));
            [...state.bluePicks, ...state.redPicks].forEach(id => {
                document.getElementById(`char-${id}`)?.classList.add('disabled');
            });
        }

        function renderSlots(state) {
            let allFlat = [];
            Object.values(charsData).forEach(arr => allFlat.push(...arr));
            
            const isClassic = state.draftType === 'classic';
            const steps = isClassic ? STEPS_CLASSIC : STEPS_GITCG;
            
            const banCount = isClassic ? 2 : 5;

            const fill = (containerId, items, max, stepNumbers, isBan) => {
                const div = document.getElementById(containerId);
                div.innerHTML = '';
                if (max === 0) return;
                for (let i = 0; i < max; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot-circle';
                    if (isBan) slot.classList.add('slot-ban');
                    let charId = null;
                    if (items[i]) charId = typeof items[i] === 'object' ? items[i].id : items[i];
                    if (charId) {
                        const char = allFlat.find(c => c.id === charId);
                        if (char) slot.innerHTML = `<img src="${char.img}">`;
                    } else {
                        const stepNum = stepNumbers[i] || '';
                        slot.innerHTML = `<span class="step-number">${stepNum}</span>`;
                        if (state.stepIndex === stepNum) slot.classList.add('active-slot');
                    }
                    div.appendChild(slot);
                }
            };

            fill('blue-bans', state.bans.filter(b => b.team === 'blue'), banCount, steps.blueBan, true);
            fill('red-bans', state.bans.filter(b => b.team === 'red'), banCount, steps.redBan, true);

            if (isClassic) {
                fill('blue-picks-1', state.bluePicks, 3, steps.bluePick, false);
                fill('blue-picks-2', [], 0, [], false);
                fill('red-picks-1', state.redPicks, 3, steps.redPick, false);
                fill('red-picks-2', [], 0, [], false);
            } else {
                fill('blue-picks-1', state.bluePicks.slice(0, 5), 5, steps.bluePick.slice(0, 5), false);
                fill('blue-picks-2', state.bluePicks.slice(5, 9), 4, steps.bluePick.slice(5, 9), false);
                fill('red-picks-1', state.redPicks.slice(0, 5), 5, steps.redPick.slice(0, 5), false);
                fill('red-picks-2', state.redPicks.slice(5, 9), 4, steps.redPick.slice(5, 9), false);
            }
        }
    </script>
</body>
</html>
