<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Genshin Draft</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="lobby-screen">
    <h1>Genshin Draft</h1>
    <input id="nickname-input" placeholder="Your Nickname" maxlength="15">
    <br><br>
    <button onclick="createGame()">Create (Blue)</button>
    <div style="margin-top:20px; border-top: 1px solid #444; padding-top:20px;">
        <input id="room-input" placeholder="Room Code">
        <button onclick="joinGame()">Join (Red)</button>
    </div>
</div>

<div id="game-screen" style="display:none;">
    <div class="header">
        <div style="color: #4facfe; font-size: 14px;">Blue Reserve: <span id="blue-res">5:00</span></div>
        <div id="timer">60</div>
        <div style="color: #ff6b6b; font-size: 14px;">Red Reserve: <span id="red-res">5:00</span></div>
        <div id="status">Waiting...</div>
    </div>

        <div class="draft-area">
            <div class="team-side blue-side">
                <h2 id="blue-name-display">PLAYER 1</h2>
                <div class="ban-row" id="blue-bans"></div>
                <div class="pick-row" id="blue-picks-1"></div>
                <div class="pick-row-small" id="blue-picks-2"></div>
            </div>

            <div class="team-side red-side">
                <h2 id="red-name-display">PLAYER 2</h2>
                <div class="ban-row" id="red-bans"></div>
                <div class="pick-row" id="red-picks-1"></div>
                <div class="pick-row-small" id="red-picks-2"></div>
            </div>
        </div>

        <div class="char-pool" id="char-pool-container"></div>
    </div>

    <script>
        const socket = io();
        let myRole = '';
        let currentRoom = '';
        let charsData = {};

        const STEPS_BLUE_BAN = [1, 2, 5, 13, 21];
        const STEPS_RED_BAN = [3, 4, 11, 19, 23];
        const STEPS_BLUE_PICK = [6, 9, 10, 14, 17, 18, 22, 25, 26];
        const STEPS_RED_PICK = [7, 8, 12, 15, 16, 20, 24, 27, 28];

        function createGame() { 
            const nick = document.getElementById('nickname-input').value;
            if(!nick) return alert("Nickname!");
            socket.emit('create_game', nick); 
        }

        function joinGame() { 
            const nick = document.getElementById('nickname-input').value;
            const room = document.getElementById('room-input').value;
            if(!nick || !room) return alert("Введите ник и код!");
            socket.emit('join_game', {roomId: room, nickname: nick}); 
        }

        socket.on('init_game', (data) => {
            myRole = data.role;
            currentRoom = data.roomId;
            charsData = data.chars;
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            renderRows();
            updateUI(data.state);
        });

        socket.on('update_state', updateUI);
        // Функция форматирования времени (секунды -> ММ:СС)
function formatTime(s) {
    if (s < 0) s = 0;
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return `${m}:${sec < 10 ? '0' : ''}${sec}`;
}

socket.on('timer_tick', (data) => {
    // Если приходит просто число (старый код) или объект (новый)
    const mainTime = typeof data === 'object' ? data.main : data;
    
    document.getElementById('timer').innerText = mainTime;
    
    // Если пришли резервы, обновляем их
    if (typeof data === 'object') {
        const blueRes = document.getElementById('blue-res');
        const redRes = document.getElementById('red-res');
        
        if(blueRes) blueRes.innerText = formatTime(data.blueReserve);
        if(redRes) redRes.innerText = formatTime(data.redReserve);
        
        // Визуально показываем, что тратится резерв (красный таймер)
        const timerEl = document.getElementById('timer');
        if (mainTime === 0) {
             timerEl.style.color = '#555'; // Основной погас
             timerEl.style.fontSize = '20px'; // Делаем поменьше, чтобы не отвлекал
        } else {
             timerEl.style.color = '#ff5555';
             timerEl.style.fontSize = '28px';
        }
    }
});

        function renderRows() {
            const container = document.getElementById('char-pool-container');
            container.innerHTML = '';
            
            const elements = ['cryo', 'hydro', 'pyro', 'electro', 'anemo', 'geo', 'dendro'];
            
            elements.forEach(elem => {
                const rowDiv = document.createElement('div');
                rowDiv.className = `element-row row-${elem}`;
                
                // Делим персонажей пополам
                const chars = charsData[elem];
                const mid = Math.ceil(chars.length / 2);
                const leftPart = chars.slice(0, mid);
                const rightPart = chars.slice(mid);

                // Левая часть
                const leftDiv = document.createElement('div');
                leftDiv.className = 'row-half left-half';
                leftPart.forEach(char => {
                    leftDiv.appendChild(createChar(char));
                });

                // Разделитель
                const gapDiv = document.createElement('div');
                gapDiv.className = 'row-gap';

                // Правая часть
                const rightDiv = document.createElement('div');
                rightDiv.className = 'row-half right-half';
                rightPart.forEach(char => {
                    rightDiv.appendChild(createChar(char));
                });

                rowDiv.appendChild(leftDiv);
                rowDiv.appendChild(gapDiv);
                rowDiv.appendChild(rightDiv);
                
                container.appendChild(rowDiv);
            });
        }

        function createChar(char) {
            const el = document.createElement('div');
            el.className = 'char-option';
            el.id = `char-${char.id}`;
            el.innerHTML = `<img src="${char.img}">`;
            el.onclick = () => socket.emit('action', { roomId: currentRoom, charId: char.id });
            return el;
        }

        function updateUI(state) {
    document.getElementById('blue-name-display').innerText = state.blueName;
    document.getElementById('red-name-display').innerText = state.redName;
    
    // ПЕРЕВОД НА АНГЛИЙСКИЙ ЗДЕСЬ
    const team = state.currentTeam === 'blue' ? 'BLUE' : 'RED';
    const act = state.currentAction === 'ban' ? 'BANNING' : 'PICKING';
    
    document.getElementById('status').innerText = `${team} IS ${act} (Turn ${state.stepIndex}) | Room: ${currentRoom}`;

    renderSlots(state);

    document.querySelectorAll('.char-option').forEach(el => el.classList.remove('disabled'));
    state.bans.forEach(b => document.getElementById(`char-${b.id}`)?.classList.add('disabled'));
    [...state.bluePicks, ...state.redPicks].forEach(id => {
        document.getElementById(`char-${id}`)?.classList.add('disabled');
    });
}

        function renderSlots(state) {
            let allFlat = [];
            Object.values(charsData).forEach(arr => allFlat.push(...arr));

            const fill = (containerId, items, max, stepNumbers, isBan) => {
                const div = document.getElementById(containerId);
                div.innerHTML = '';
                for (let i = 0; i < max; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot-circle';
                    if (isBan) slot.classList.add('slot-ban');

                    let charId = null;
                    if (items[i]) charId = typeof items[i] === 'object' ? items[i].id : items[i];

                    if (charId) {
                        const char = allFlat.find(c => c.id === charId);
                        if (char) slot.innerHTML = `<img src="${char.img}">`;
                    } else {
                        const stepNum = stepNumbers[i] || '';
                        slot.innerHTML = `<span class="step-number">${stepNum}</span>`;
                        if (state.stepIndex === stepNum) slot.classList.add('active-slot');
                    }
                    div.appendChild(slot);
                }
            };

            fill('blue-bans', state.bans.filter(b => b.team === 'blue'), 5, STEPS_BLUE_BAN, true);
            fill('red-bans', state.bans.filter(b => b.team === 'red'), 5, STEPS_RED_BAN, true);

            fill('blue-picks-1', state.bluePicks.slice(0, 5), 5, STEPS_BLUE_PICK.slice(0, 5), false);
            fill('blue-picks-2', state.bluePicks.slice(5, 9), 4, STEPS_BLUE_PICK.slice(5, 9), false);

            fill('red-picks-1', state.redPicks.slice(0, 5), 5, STEPS_RED_PICK.slice(0, 5), false);
            fill('red-picks-2', state.redPicks.slice(5, 9), 4, STEPS_RED_PICK.slice(5, 9), false);
        }
    </script>
</body>
</html>
