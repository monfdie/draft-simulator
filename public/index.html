<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GITCG Draft</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="draft-rules.js"></script>
</head>
<body>
    <div id="lobby-screen">
        <div class="lobby-card">
            <div class="corner corner-tl"></div>
            <div class="corner corner-tr"></div>
            <div class="corner corner-bl"></div>
            <div class="corner corner-br"></div>

            <div class="lobby-header">
                <h1>GITCG Draft</h1>
                <div class="header-decoration"></div>
            </div>

            <div class="lobby-content">
                <div class="input-group main-input">
                    <label>NICKNAME</label>
                    <input id="nickname-input" placeholder="Enter your name..." maxlength="15" autocomplete="off">
                </div>

                <div class="section-block create-section">
                    <div class="section-title">CREATE NEW GAME</div>
                    <div class="input-row">
                        <select id="draft-type-select">
                            <option value="gitcg">GITCG CUP</option>
                            <option value="gitcg_cup_2">GITCG CUP 2 (Immunity)</option>
                            <option value="classic">Classic (2 Bans / 3 Picks)</option>
                            <option value="generals_2">Generals 2</option>
                        </select>
                        <button class="btn-genshin btn-gold" onclick="createGame()">Create</button>
                    </div>
                </div>

                <div class="separator-fancy">
                    <span class="sep-line"></span>
                    <span class="sep-text">OR JOIN</span>
                    <span class="sep-line"></span>
                </div>

                <div class="section-block join-section">
                    <div class="input-row">
                        <input id="room-input" placeholder="Room Code" style="text-transform: uppercase;">
                        <button class="btn-genshin btn-blue" onclick="joinGame()">Join</button>
                    </div>
                    
                    <label class="custom-checkbox">
                        <input type="checkbox" id="spectator-check">
                        <span class="checkmark"></span>
                        <span>Join as Spectator</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" style="display:none;">
       <div class="header">
            <div id="room-container">
                <div id="room-display" onclick="copyRoomCode()" title="Click to copy room code">CODE: ----</div>
                <span id="copy-toast">Code Copied!</span>
            </div>
            <div class="reserve-timer blue-res"><span id="blue-res">5:00</span></div>
            <div id="status">Waiting...</div>
            <div class="reserve-timer red-res"><span id="red-res">5:00</span></div>
        </div>

        <div class="draft-area">
            <div id="immunity-top-display" class="immunity-top-container" style="display: none;">
                <div class="im-label">IMMUNE</div>
                <div class="im-row" id="immunity-icons-row"></div>
            </div>

            <div class="team-side blue-side">
                <div class="player-header">
                    <div id="blue-timer" class="turn-timer">60</div>
                    <h2 id="blue-name-display">PLAYER 1</h2>
                    <div id="blue-ready-switch" class="ready-switch" onclick="toggleReady('blue')">
                        <div class="switch-circle"></div>
                    </div>
                </div>
                <div class="ban-row" id="blue-bans"></div>
                <div class="pick-row" id="blue-picks-1"></div>
                <div class="pick-row-small" id="blue-picks-2"></div>
            </div>

            <div class="center-axis">
                <div class="mid-label ban-label">BANS</div>
                <div class="mid-label pick-label">PICKS</div>
            </div>

            <div class="team-side red-side">
                <div class="player-header">
                    <div id="red-ready-switch" class="ready-switch" onclick="toggleReady('red')">
                        <div class="switch-circle"></div>
                    </div>
                    <h2 id="red-name-display">PLAYER 2</h2>
                    <div id="red-timer" class="turn-timer">60</div>
                </div>
                <div class="ban-row" id="red-bans"></div>
                <div class="pick-row" id="red-picks-1"></div>
                <div class="pick-row-small" id="red-picks-2"></div>
            </div>
        </div>

        <div class="controls-area">
            <button id="confirm-btn" class="confirm-btn" onclick="confirmSelection()" disabled>SELECT</button>
        </div>

        <div class="char-pool" id="char-pool-container"></div>
    </div>

    <script>
        const socket = io({ transports: ['websocket'] });

        socket.on('connect', () => {
            const savedRoom = sessionStorage.getItem('draft_room_id');
            const myId = sessionStorage.getItem('draft_user_id');
            if (savedRoom && myId) {
                socket.emit('rejoin_game', { roomId: savedRoom, userId: myId });
            }
        });

        socket.on('error_msg', (msg) => {
            if (msg === 'Session expired' || msg === 'Room not found') {
                sessionStorage.removeItem('draft_room_id'); 
                if (document.getElementById('game-screen').style.display !== 'none') {
                    alert("Game session expired.");
                    window.location.href = "/"; 
                }
            } else {
                alert(msg);
            }
        });

        let myRole = '', currentRoom = '', currentDraftType = 'gitcg';
        let charsData = {}, selectedCharId = null, isGameStarted = false, activeTeam = 'blue'; 
        let myUserId = sessionStorage.getItem('draft_user_id') || Math.random().toString(36).substring(2);
        sessionStorage.setItem('draft_user_id', myUserId);

        function createGame() { 
            const nick = document.getElementById('nickname-input').value;
            const type = document.getElementById('draft-type-select').value;
            if(!nick) return alert("Enter nickname!");
            socket.emit('create_game', { nickname: nick, draftType: type, userId: myUserId }); 
        }
        function joinGame() { 
            const nick = document.getElementById('nickname-input').value;
            const room = document.getElementById('room-input').value;
            const isSpec = document.getElementById('spectator-check').checked;
            if(!nick || !room) return alert("Enter nickname and code!");
            socket.emit('join_game', {roomId: room, nickname: nick, asSpectator: isSpec, userId: myUserId}); 
        }

        socket.on('init_game', (data) => {
            myRole = data.role; currentRoom = data.roomId; charsData = data.chars;
            currentDraftType = data.state.draftType || 'gitcg';
            sessionStorage.setItem('draft_room_id', currentRoom);
            document.getElementById('room-display').innerText = `CODE: ${currentRoom}` + (myRole === 'spectator' ? " (SPEC)" : "");
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            renderRows(); updateUI(data.state);
        });

        socket.on('update_state', updateUI);
        socket.on('game_started', () => { isGameStarted = true; });
        socket.on('game_over', (state) => { 
            updateUI(state); 
            setTimeout(() => alert("Draft Completed!"), 500); 
            sessionStorage.removeItem('draft_room_id'); 
        });
        
        socket.on('timer_tick', (data) => {
            const t = typeof data === 'object' ? data.main : data;
            const b = document.getElementById('blue-timer'), r = document.getElementById('red-timer');
            if(activeTeam==='blue') { b.innerText=t; r.innerText="60"; b.style.color=t<10?'#ff5555':'#4facfe'; }
            else { r.innerText=t; b.innerText="60"; r.style.color=t<10?'#ff5555':'#ff6b6b'; }
            if(typeof data === 'object') {
                document.getElementById('blue-res').innerText = formatTime(data.blueReserve);
                document.getElementById('red-res').innerText = formatTime(data.redReserve);
            }
        });

        function formatTime(s) { const m=Math.floor(s/60), sec=s%60; return `${m}:${sec<10?'0':''}${sec}`; }
        function toggleReady(r) { if(myRole===r) socket.emit('player_ready', currentRoom); }
        function copyRoomCode() { 
            if (!currentRoom) return;
            navigator.clipboard.writeText(currentRoom).then(() => {
                const toast = document.getElementById('copy-toast');
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); }, 2000);
            });
        }
        
        function renderRows() {
            const container = document.getElementById('char-pool-container');
            container.innerHTML = '';
            const ladder = document.createElement('div'); ladder.className = 'ladder-container';
            const schema = DRAFT_RULES[currentDraftType];
            
            schema.forEach((step, i) => {
                const d = document.createElement('div');
                d.className = `ladder-step step-${step.team}`;
                if(step.immunity) d.classList.add('step-immunity');
                d.id = `step-node-${i}`; d.innerText = `${i+1}. ${step.type}`;
                ladder.appendChild(d);
            });
            container.appendChild(ladder);

            ['cryo','hydro','pyro','electro','anemo','geo','dendro'].forEach(elem => {
                const row = document.createElement('div'); row.className = `element-row row-${elem}`;
                const chars = charsData[elem], mid = Math.ceil(chars.length/2);
                const l = document.createElement('div'); l.className = 'row-half left-half';
                chars.slice(0,mid).forEach(c => l.appendChild(createChar(c)));
                const gap = document.createElement('div'); gap.className = 'row-gap';
                const r = document.createElement('div'); r.className = 'row-half right-half';
                chars.slice(mid).forEach(c => r.appendChild(createChar(c)));
                row.appendChild(l); row.appendChild(gap); row.appendChild(r);
                container.appendChild(row);
            });
        }

        function createChar(char) {
            const el = document.createElement('div'); el.className = 'char-option'; el.id = `char-${char.id}`;
            el.innerHTML = `<img src="${char.img}">`;
            el.onclick = () => {
                if(!isGameStarted || myRole === 'spectator') return;
                document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
                selectedCharId = char.id; el.classList.add('selected-pending');
                document.getElementById('confirm-btn').disabled = false;
            };
            return el;
        }

        function confirmSelection() {
            if(selectedCharId && currentRoom) {
                socket.emit('action', { roomId: currentRoom, charId: selectedCharId });
                selectedCharId = null; document.getElementById('confirm-btn').disabled = true;
                document.querySelectorAll('.char-option').forEach(c => c.classList.remove('selected-pending'));
            }
        }

        function updateImmunityTop(state) {
            const topDisp = document.getElementById('immunity-top-display');
            if(state.draftType !== 'gitcg_cup_2') { topDisp.style.display = 'none'; return; }
            topDisp.style.display = 'flex';
            const row = document.getElementById('immunity-icons-row');
            row.innerHTML = '';
            const bans = state.immunityBans || [];
            const picks = state.immunityPool || [];
            const slots = [ { id: bans[0], type: 'ban' }, { id: picks[0], type: 'pick' }, { id: picks[1], type: 'pick' }, { id: bans[1], type: 'ban' } ];
            slots.forEach(slot => {
                const div = document.createElement('div');
                div.className = `im-icon im-${slot.type}`;
                if (slot.id) {
                    let all = []; Object.values(charsData).forEach(a => all.push(...a));
                    const char = all.find(c => c.id === slot.id);
                    if(char) div.innerHTML = `<img src="${char.img}">`;
                } else div.classList.add('im-empty');
                row.appendChild(div);
            });
        }

        function updateUI(state) {
            isGameStarted = state.gameStarted; activeTeam = state.currentTeam;
            document.getElementById('blue-ready-switch').style.display = state.gameStarted?'none':'flex';
            document.getElementById('red-ready-switch').style.display = state.gameStarted?'none':'flex';
            if(!state.gameStarted) {
                state.ready.blue ? document.getElementById('blue-ready-switch').classList.add('ready-on') : document.getElementById('blue-ready-switch').classList.remove('ready-on');
                state.ready.red ? document.getElementById('red-ready-switch').classList.add('ready-on') : document.getElementById('red-ready-switch').classList.remove('ready-on');
            }
            document.getElementById('blue-name-display').innerText = state.blueName;
            document.getElementById('red-name-display').innerText = state.redName;
            
            let txt = "WAITING...";
            if(state.immunityPhaseActive) txt = `IMMUNITY: ${state.currentTeam} ${state.currentAction}`;
            else if(state.gameStarted) txt = `${state.currentTeam} IS ${state.currentAction==='ban'?'BANNING':'PICKING'}`;
            document.getElementById('status').innerText = txt.toUpperCase();

            updateImmunityTop(state);

            const idx = state.stepIndex - 1;
            const currentSchema = DRAFT_RULES[currentDraftType];
            const len = currentSchema.length;

            if(!state.immunityPhaseActive) {
                for(let i=0; i<len; i++) {
                    const n = document.getElementById(`step-node-${i}`);
                    if(!n) continue;
                    n.classList.remove('step-active','step-done');
                    if(i < idx) n.classList.add('step-done');
                    else if(i === idx && state.gameStarted) {
                        n.classList.add('step-active');
                        setTimeout(() => n.scrollIntoView({behavior:'smooth', block:'center'}), 50);
                    }
                }
            }

            renderSlots(state);

            document.querySelectorAll('.char-option').forEach(el => {
                el.classList.remove('disabled', 'immunity-highlight');
                // Убираем классы рамок, чтобы они не накапливались при смене слота
                ['pyro', 'hydro', 'cryo', 'electro', 'anemo', 'geo', 'dendro'].forEach(e => 
                    el.classList.remove(`border-${e}`));
            });

            state.bans.forEach(b => document.getElementById(`char-${b.id}`)?.classList.add('disabled'));
            [...state.bluePicks, ...state.redPicks].forEach(id => document.getElementById(`char-${id}`)?.classList.add('disabled'));
            if(state.immunityPhaseActive) {
                [...state.immunityBans, ...state.immunityPool].forEach(id => document.getElementById(`char-${id}`)?.classList.add('disabled'));
            } else {
                const step = currentSchema[idx];
                const isImmunityTurn = step && step.immunity;
                state.immunityPool.forEach(id => {
                    const el = document.getElementById(`char-${id}`);
                    if(!el) return;
                    if(state.currentAction === 'ban') el.classList.add('disabled');
                    else if (state.currentAction === 'pick') {
                        if(isImmunityTurn) {
                            const myPicks = activeTeam === 'blue' ? state.bluePicks : state.redPicks;
                            if(!myPicks.includes(id)) { el.classList.remove('disabled'); el.classList.add('immunity-highlight'); }
                        } else el.classList.add('disabled');
                    }
                });
            }
            if(state.gameStarted && myRole !== 'spectator' && myRole !== state.currentTeam) {
                document.querySelectorAll('.char-option').forEach(el => el.classList.add('disabled'));
            }
        }

        function getStepsFor(schema, team, type) {
            if (!schema) return [];
            return schema
                .map((step, index) => ({ ...step, globalIndex: index + 1 }))
                .filter(step => step.team === team && step.type === type)
                .map(step => ({ num: step.globalIndex, immunity: step.immunity }));
        }

        // --- НОВАЯ ЛОГИКА ОПРЕДЕЛЕНИЯ ЭЛЕМЕНТА ---
        function getCharInfo(id) {
            for (const [element, chars] of Object.entries(charsData)) {
                const found = chars.find(c => c.id === id);
                if (found) return { ...found, element };
            }
            return null;
        }

        function renderSlots(state) {
            const currentSchema = DRAFT_RULES[currentDraftType];
            const blueBanSteps = getStepsFor(currentSchema, 'blue', 'ban');
            const redBanSteps = getStepsFor(currentSchema, 'red', 'ban');
            const bluePickSteps = getStepsFor(currentSchema, 'blue', 'pick');
            const redPickSteps = getStepsFor(currentSchema, 'red', 'pick');

            const fill = (containerId, items, stepData, isBan) => {
                const div = document.getElementById(containerId);
                div.innerHTML = ''; 
                stepData.forEach((step, i) => {
                    const slot = document.createElement('div');
                    slot.className = 'slot-circle';
                    if (isBan) slot.classList.add('slot-ban');
                    if (step.immunity) slot.classList.add('slot-immunity-pick');

                    let charId = null;
                    if (items[i]) charId = typeof items[i] === 'object' ? items[i].id : items[i];

                    if (charId) {
                        const info = getCharInfo(charId);
                        if (info) {
                            slot.innerHTML = `<img src="${info.img}">`;
                            // ДОБАВЛЯЕМ КЛАСС ЭЛЕМЕНТА
                            slot.classList.add(`border-${info.element}`);
                        }
                    } else slot.innerHTML = `<span class="step-number">${step.num}</span>`;
                    div.appendChild(slot);
                });
            };

            // Заполняем баны
            fill('blue-bans', state.bans.filter(b => b.team === 'blue'), blueBanSteps, true);
            fill('red-bans', state.bans.filter(b => b.team === 'red'), redBanSteps, true);
            
            if (currentDraftType === 'generals_2') {
                fill('blue-picks-1', state.bluePicks, bluePickSteps, false);
                fill('blue-picks-2', [], [], false); 
                fill('red-picks-1', state.redPicks, redPickSteps, false);
                fill('red-picks-2', [], [], false);
            } else if (currentDraftType === 'classic') {
                fill('blue-picks-1', state.bluePicks, bluePickSteps, false);
                fill('blue-picks-2', [], [], false);
                fill('red-picks-1', state.redPicks, redPickSteps, false);
                fill('red-picks-2', [], [], false);
            } else {
                fill('blue-picks-1', state.bluePicks.slice(0, 5), bluePickSteps.slice(0, 5), false);
                fill('blue-picks-2', state.bluePicks.slice(5, 9), bluePickSteps.slice(5, 9), false);
                fill('red-picks-1', state.redPicks.slice(0, 5), redPickSteps.slice(0, 5), false);
                fill('red-picks-2', state.redPicks.slice(5, 9), redPickSteps.slice(5, 9), false);
            }
        }
    </script>
</body>
</html>
